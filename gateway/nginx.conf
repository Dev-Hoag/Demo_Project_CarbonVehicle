worker_processes auto;
events { worker_connections 1024; }

http {
  include       mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  keepalive_timeout 65;
  gzip on;
  gzip_types text/plain application/json application/javascript text/css;

  # Upstream theo container_name:port nội bộ
  upstream admin_service { server admin_service_app:3000; }
  upstream user_service  { server user_service_app:3001; }
  upstream pay_service   { server payment_service_app:3002; }

  # Rate limit
  limit_req_zone $binary_remote_addr zone=login_zone:10m rate=10r/s;
  limit_req_zone $binary_remote_addr zone=ipn_zone:10m   rate=50r/s;

  # Whitelist origin
  map $http_origin $cors_allow_origin {
    default "";
    "~^https?://localhost(:\d+)?$" $http_origin;
    "~^https?://127\.0\.0\.1(:\d+)?$" $http_origin;
  }

  # Common security and CORS headers
  map $uri $security_headers {
    default "nosniff DENY strict-origin-when-cross-origin";
  }

  server {
    listen 80;

    # ----- Health -> Admin -----
    location ~ ^/health(|/live|/ready)$ {
      # Security headers
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header Referrer-Policy strict-origin-when-cross-origin;

      # CORS headers
      add_header Access-Control-Allow-Origin $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://admin_service;

      # preflight (ít gặp ở health nhưng thêm cho đủ)
      if ($request_method = OPTIONS) { return 204; }
    }

    # ----- User Service -----
    # Rate-limited login (exact match) - must be its own location so `limit_req` is
    # in a valid context (not inside an `if`). Exact-match locations are checked
    # before regex locations.
    location = /api/auth/login {
      # Security headers
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header Referrer-Policy strict-origin-when-cross-origin;

      # CORS headers
      add_header Access-Control-Allow-Origin $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

      # preflight
      if ($request_method = OPTIONS) { return 204; }

      limit_req zone=login_zone burst=20 nodelay;

      proxy_http_version 1.1; proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://user_service;
    }

    location ~ ^/(api/auth|api/users|api/kyc) {
      # Security headers
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header Referrer-Policy strict-origin-when-cross-origin;

      # CORS headers
      add_header Access-Control-Allow-Origin $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

      # preflight
      if ($request_method = OPTIONS) { return 204; }

      proxy_http_version 1.1; proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://user_service;
    }

    # ----- Admin Service -----
    location ^~ /api/admin {
      # Security headers
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header Referrer-Policy strict-origin-when-cross-origin;

      # CORS headers
      add_header Access-Control-Allow-Origin $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

      # preflight
      if ($request_method = OPTIONS) { return 204; }

      proxy_http_version 1.1; proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://admin_service;
    }

    # ----- Payment Service -----
    # Exact-match location for vnpay IPN so we can apply rate-limiting safely
    location = /api/payments/vnpay/ipn {
      # Security headers
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header Referrer-Policy strict-origin-when-cross-origin;

      # CORS headers
      add_header Access-Control-Allow-Origin $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

      # preflight
      if ($request_method = OPTIONS) { return 204; }

      limit_req zone=ipn_zone burst=100 nodelay;

      proxy_http_version 1.1; proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://pay_service;
    }

    location ^~ /api/payments {
      # Security headers
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header Referrer-Policy strict-origin-when-cross-origin;

      # CORS headers
      add_header Access-Control-Allow-Origin $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

      # preflight
      if ($request_method = OPTIONS) { return 204; }

      proxy_http_version 1.1; proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://pay_service;
    }

    # Mặc định 404
    location / { 
      # Security headers
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header Referrer-Policy strict-origin-when-cross-origin;

      # CORS headers
      add_header Access-Control-Allow-Origin $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

      if ($request_method = OPTIONS) { return 204; }
      return 404; 
    }

    client_max_body_size 20m;
    proxy_connect_timeout 5s;
    proxy_send_timeout   60s;
    proxy_read_timeout   60s;
    send_timeout         60s;
  }
}
