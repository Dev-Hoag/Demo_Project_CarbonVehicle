worker_processes auto;

events { worker_connections 1024; }

http {
  # Quan tr·ªçng: d√πng Docker DNS resolver v√† cho ph√©p re-resolve ƒë·ªãnh k·ª≥
  resolver 127.0.0.11 valid=10s ipv6=off;

  include       mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  keepalive_timeout 65;

  gzip on;
  gzip_types text/plain application/json application/javascript text/css;

  # Rate limit
  limit_req_zone $binary_remote_addr zone=login_zone:10m rate=10r/s;
  limit_req_zone $binary_remote_addr zone=ipn_zone:10m   rate=50r/s;

  # Whitelist origin
  map $http_origin $cors_allow_origin {
    default "";
    "~^https?://localhost(:\d+)?$"      $http_origin;
    "~^https?://127\.0\.0\.1(:\d+)?$"   $http_origin;
  }

  # ============================================
  # üîê JWT AUTHENTICATION SETUP
  # ============================================
  # C√°c bi·∫øn n√†y s·∫Ω ƒë∆∞·ª£c set b·ªüi auth_request t·ª´ /internal/auth/verify
  # Gateway s·∫Ω forward c√°c bi·∫øn n√†y v√†o request headers cho backend services
  map $upstream_http_x_user_id $auth_user_id {
    default $upstream_http_x_user_id;
  }

  map $upstream_http_x_user_role $auth_user_role {
    default $upstream_http_x_user_role;
  }

  map $upstream_http_x_user_email $auth_user_email {
    default $upstream_http_x_user_email;
  }

  # (Tu·ª≥ ch·ªçn) n·∫øu mu·ªën d√πng Content-Security-Policy nghi√™m ng·∫∑t th√¨ th√™m ri√™ng
  # map $uri $security_headers { default "nosniff DENY strict-origin-when-cross-origin"; }

  server {
    listen 80;

    # ============================================
    # üîê INTERNAL: JWT Verification Endpoint
    # ============================================
    # Location n√†y KH√îNG ƒë∆∞·ª£c truy c·∫≠p t·ª´ b√™n ngo√†i (internal directive)
    # Ch·ªâ ƒë∆∞·ª£c g·ªçi b·ªüi auth_request directive trong c√°c protected routes
    # 
    # Flow:
    # 1. Client g·ª≠i request v·ªõi Authorization: Bearer <token>
    # 2. Nginx g·ªçi /auth-verify (internal subrequest)
    # 3. /auth-verify forward request ƒë·∫øn User Service /internal/auth/verify
    # 4. User Service verify token v√† tr·∫£ v·ªÅ user info trong response body JSON:
    #    { "userId": "123", "userRole": "EV_OWNER", "email": "user@test.com" }
    # 5. N·∫øu token h·ª£p l·ªá (200 OK) ‚Üí nginx ti·∫øp t·ª•c forward request ch√≠nh
    # 6. N·∫øu token invalid (401) ‚Üí nginx tr·∫£ v·ªÅ 401 cho client ngay
    #
    location = /auth-verify {
      internal;  # üëà Ch·ªâ c√≥ th·ªÉ ƒë∆∞·ª£c g·ªçi t·ª´ internal subrequest, kh√¥ng th·ªÉ truy c·∫≠p t·ª´ browser

      # Forward request ƒë·∫øn User Service
      proxy_pass http://user_service_app:3001/internal/auth/verify;
      
      # Pass Authorization header t·ª´ request g·ªëc
      proxy_pass_request_body off;
      proxy_set_header Content-Length "";
      proxy_set_header Authorization $http_authorization;
      
      # L∆∞u l·∫°i response t·ª´ User Service ƒë·ªÉ extract user info
      # Response body s·∫Ω ch·ª©a JSON: {"userId": "...", "userRole": "...", "email": "..."}
      proxy_set_header X-Original-URI $request_uri;
      proxy_set_header X-Original-Method $request_method;
    }

    # ===== Public Routes: Health Check (kh√¥ng c·∫ßn auth) =====
    location ~ ^/health(|/live|/ready)$ {
      # Security headers
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header Referrer-Policy strict-origin-when-cross-origin;

      # CORS
      add_header Access-Control-Allow-Origin $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

      if ($request_method = OPTIONS) { return 204; }

      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      # Proxy th·∫≥ng b·∫±ng hostname container (ƒë·ªÉ Docker DNS re-resolve)
      proxy_pass http://admin_service_app:3000;
    }

    # ============================================
    # üìñ PUBLIC ROUTES - User Service (kh√¥ng c·∫ßn JWT)
    # ============================================
    # C√°c endpoint n√†y cho ph√©p truy c·∫≠p m√† kh√¥ng c·∫ßn authentication
    # Bao g·ªìm: login, register
    
    # Login endpoint - c√≥ rate limiting
    location = /api/auth/login {
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header Referrer-Policy strict-origin-when-cross-origin;

      add_header Access-Control-Allow-Origin $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

      if ($request_method = OPTIONS) { return 204; }

      limit_req zone=login_zone burst=20 nodelay;

      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://user_service_app:3001;
    }

    # Register endpoint - public access
    location = /api/auth/register {
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header Referrer-Policy strict-origin-when-cross-origin;

      add_header Access-Control-Allow-Origin $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

      if ($request_method = OPTIONS) { return 204; }

      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://user_service_app:3001;
    }

    # Other public auth routes: verify email, forgot/reset password
    location ~ ^/api/auth/(verify|forgot-password|reset-password)$ {
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header Referrer-Policy strict-origin-when-cross-origin;

      add_header Access-Control-Allow-Origin $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

      if ($request_method = OPTIONS) { return 204; }

      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://user_service_app:3001;
    }

    # ============================================
    # üîê PROTECTED ROUTES - Require JWT Authentication
    # ============================================
    # T·∫•t c·∫£ routes d∆∞·ªõi ƒë√¢y ƒë·ªÅu c·∫ßn JWT token h·ª£p l·ªá
    # Gateway s·∫Ω g·ªçi /auth-verify tr∆∞·ªõc ‚Üí n·∫øu OK m·ªõi forward request
    
    # Protected auth routes: /api/auth/me, /api/auth/refresh
    location ~ ^/api/auth/(me|refresh)$ {
      # üîê JWT Authentication required
      auth_request /auth-verify;

      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header Referrer-Policy strict-origin-when-cross-origin;

      add_header Access-Control-Allow-Origin $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

      if ($request_method = OPTIONS) { return 204; }

      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://user_service_app:3001;
    }
    
    # Protected User Service routes: /api/users/*, /api/kyc/*
    location ~ ^/(api/users|api/kyc) {
      # üîê JWT Authentication - verify token tr∆∞·ªõc khi forward
      auth_request /auth-verify;
      
      # Sau khi verify OK, extract user info t·ª´ response
      # auth_request_set s·∫Ω l·∫•y gi√° tr·ªã t·ª´ upstream response
      # Nh∆∞ng v√¨ User Service tr·∫£ v·ªÅ JSON body, kh√¥ng ph·∫£i headers,
      # n√™n ta c·∫ßn parse JSON. T·∫°m th·ªùi comment out, s·∫Ω d√πng c√°ch kh√°c
      # auth_request_set $user_id $upstream_http_x_user_id;
      # auth_request_set $user_role $upstream_http_x_user_role;

      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header Referrer-Policy strict-origin-when-cross-origin;

      add_header Access-Control-Allow-Origin $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

      if ($request_method = OPTIONS) { return 204; }

      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      
      # TODO: Pass user info to backend
      # proxy_set_header X-User-ID $user_id;
      # proxy_set_header X-User-Role $user_role;
      
      proxy_pass http://user_service_app:3001;
    }

    # ===== Admin Service - PROTECTED =====
    location ^~ /api/admin {
      # üîê JWT Authentication required
      auth_request /auth-verify;

      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header Referrer-Policy strict-origin-when-cross-origin;

      add_header Access-Control-Allow-Origin $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

      if ($request_method = OPTIONS) { return 204; }

      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://admin_service_app:3000;
    }

    # ===== Payment Service =====
    # VNPay IPN exact-match ƒë·ªÉ √°p rate-limit ri√™ng
    location = /api/payments/vnpay/ipn {
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header Referrer-Policy strict-origin-when-cross-origin;

      add_header Access-Control-Allow-Origin $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

      if ($request_method = OPTIONS) { return 204; }

      limit_req zone=ipn_zone burst=100 nodelay;

      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://payment_service_app:3002;
    }

    location ^~ /api/payments {
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header Referrer-Policy strict-origin-when-cross-origin;

      add_header Access-Control-Allow-Origin $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

      if ($request_method = OPTIONS) { return 204; }

      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://payment_service_app:3002;
    }

# ===== Internal Users (proxy sang user-service) =====
location ^~ /internal {
  # Security headers
  add_header X-Content-Type-Options nosniff;
  add_header X-Frame-Options DENY;
  add_header Referrer-Policy strict-origin-when-cross-origin;

  # CORS (n·∫øu c·∫ßn g·ªçi t·ª´ FE)
  add_header Access-Control-Allow-Origin $cors_allow_origin always;
  add_header Access-Control-Allow-Credentials true always;
  add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With,x-internal-secret" always;
  add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

  # Preflight
  if ($request_method = OPTIONS) { return 204; }

  proxy_http_version 1.1; proxy_set_header Connection "";
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # Proxy qua user-service container
  proxy_pass http://user_service_app:3001;
}
location ^~ /api/docs-internal {
  if ($request_method = OPTIONS) { return 204; }
  proxy_http_version 1.1; proxy_set_header Connection "";
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_pass http://user_service_app:3001;
}


    # M·∫∑c ƒë·ªãnh 404
    location / {
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header Referrer-Policy strict-origin-when-cross-origin;

      add_header Access-Control-Allow-Origin $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

      if ($request_method = OPTIONS) { return 204; }
      return 404;
    }

    # Timeouts h·ª£p l√Ω
    client_max_body_size 20m;
    proxy_connect_timeout 5s;
    proxy_send_timeout   60s;
    proxy_read_timeout   60s;
    send_timeout         60s;

    # (Tu·ª≥ ch·ªçn) retry nh·∫π khi upstream l·ªói t·∫°m th·ªùi
    proxy_next_upstream error timeout http_502 http_503 http_504;
    proxy_next_upstream_tries 3;
  }
}
