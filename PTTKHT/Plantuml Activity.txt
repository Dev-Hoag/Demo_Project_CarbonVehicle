@startuml
start

partition "Admin" {
  :Tìm kiếm / Mở hồ sơ người dùng;
  if ("Thao tác = Tạo mới?") then (Có)
    :Nhập dữ liệu cơ bản;
    :Gán vai trò & quyền (RBAC);
  else (Không)
    if ("Thao tác = Cập nhật?") then (Có)
      :Chỉnh sửa thuộc tính (email/phone/KYC...);
    else (Khóa/Mở khóa)
      :Nhập lý do & TTL;
    endif
  endif
}

partition "Hệ thống" {
  :Lưu thay đổi vào DB (idempotency key);
  if ("KYC bắt buộc?") then (Có)
    :Gửi yêu cầu KYC;
  else (Không)
    :Bỏ qua KYC;
  endif
}

partition "Dịch vụ KYC" {
  :Xử lý eKYC/đối soát blacklist;
  if ("KYC Pass?") then (Pass)
    :Trả kết quả = VERIFIED;
  else (Fail)
    :Trả kết quả = REJECTED;
  endif
}

partition "Hệ thống" {
  :Cập nhật trạng thái KYC (nếu có);
  :Ghi nhật ký audit (WORM);
  :Gửi thông báo email/SMS cho người dùng;
}

stop
@enduml
B) Giao dịch: giám sát & xử lý (UC04–UC06)
plantuml
Sao chép mã
@startuml
start

partition "Admin" {
  :Lọc & xem giao dịch thời gian thực;
  :Chọn giao dịch cần xử lý;
}

partition "Hệ thống" {
  if ("Trạng thái = PENDING?") then (Có)
    :Hiển thị log/bằng chứng liên quan;
  else (Không)
    :Thông báo: chỉ xử lý giao dịch ở trạng thái PENDING;
    stop
  endif
}

partition "Admin" {
  if ("Có dấu hiệu bất thường?") then (Có)
    :Gắn cờ nghi ngờ (flag);
  else (Không)
    :Tiếp tục;
  endif
  :Chọn hành động (Duyệt / Huỷ / Điều chỉnh);
}

partition "Hệ thống" {
  if ("Hành động = Duyệt?") then (Duyệt)
    :Ghi bút toán ledger (idempotent);
    :Cập nhật trạng thái = APPROVED;
  else (Khác)
    if ("Hành động = Huỷ?") then (Huỷ)
      :Ghi lý do huỷ;
      :Cập nhật trạng thái = CANCELED;
    else (Điều chỉnh)
      :Ghi bút toán điều chỉnh (số lượng/giá);
      :Cập nhật trạng thái = ADJUSTED;
    endif
  endif
  :Gửi thông báo cho các bên;
}

stop
@enduml
C) Tranh chấp (UC06 chi tiết)
plantuml
Sao chép mã
@startuml
start

partition "Admin" {
  :Nhận & mở hồ sơ tranh chấp;
  :Kiểm tra thông tin tối thiểu;
}

partition "Hệ thống" {
  if ("Hồ sơ đầy đủ?") then (Có)
    :Tạo/ghi hồ sơ tranh chấp;
  else (Thiếu)
    :Từ chối mở tranh chấp (thiếu thông tin);
    stop
  endif
}

partition "Admin" {
  :Thu thập bằng chứng từ các bên;
  if ("Bằng chứng đủ?") then (Đủ)
    :Đánh giá & ra quyết định;
  else (Thiếu)
    :Yêu cầu bổ sung; Chờ phản hồi (SLA);
    if ("Hết SLA?") then (Có)
      :Đóng tranh chấp - từ chối do thiếu bằng chứng;
      stop
    else (Chưa)
      :Nhận bổ sung & đánh giá lại;
    endif
  endif
}

partition "Hệ thống" {
  if ("Kết quả = Hoàn tiền?") then (Có)
    :Tạo bút toán hoàn tiền; Cập nhật ledger;
  else (Điều chỉnh)
    :Tạo bút toán điều chỉnh; Cập nhật ledger;
  endif
  :Gửi thông báo kết quả cho các bên;
}

stop
@enduml
D1) Ví & Dòng tiền — Đối soát (UC07)
plantuml
Sao chép mã
@startuml
start

partition "Admin" {
  :Chọn kỳ đối soát;
}

partition "Cổng thanh toán" {
  :Xuất sao kê giao dịch theo kỳ;
}

partition "Hệ thống" {
  :Import sao kê; Đọc sổ cái nội bộ;
  :So khớp giao dịch (diff);
  if ("Có chênh lệch?") then (Có)
    :Sinh danh sách lệch;
  else (Không)
    :Không có chênh lệch;
  endif
}

partition "Admin" {
  if ("Có chênh lệch?") then (Có)
    :Rà soát & phê duyệt bút toán điều chỉnh;
  endif
}

partition "Hệ thống" {
  if ("Được phê duyệt?") then (Có)
    :Ghi bút toán điều chỉnh;
  endif
  :Khoá kỳ đối soát;
  :Xuất báo cáo đối soát;
}

stop
@enduml
D2) Ví & Dòng tiền — Duyệt chi / Payout (UC08 + liên quan UC09)
plantuml
Sao chép mã
@startuml
start

partition "Admin" {
  :Nhận & kiểm tra yêu cầu rút tiền (số tiền, tài khoản);
}

partition "Hệ thống" {
  :Kiểm tra ví bị đóng băng? & số dư đủ?;
  if ("Ví bị đóng băng hoặc thiếu tiền?") then (Có)
    :Từ chối payout; Thông báo người dùng;
    stop
  else (Không)
    :Kiểm tra AML/KYC & hạn mức;
  endif
}

partition "Dịch vụ AML/KYC" {
  :Đối soát blacklist/limit;
  if ("Pass AML/KYC & trong hạn mức?") then (Pass)
    :Trả kết quả PASS;
  else (Fail)
    :Trả kết quả FAIL;
  endif
}

partition "Hệ thống" {
  if ("Kết quả PASS?") then (Có)
    :Tạo idempotency key; Gửi lệnh tới Cổng thanh toán;
  else (Không)
    :Từ chối payout; Thông báo & hướng dẫn hỗ trợ;
    stop
  endif
}

partition "Cổng thanh toán" {
  :Xử lý chuyển tiền; Gửi webhook kết quả;
}

partition "Hệ thống" {
  if ("Webhook = SUCCESS?") then (Thành công)
    :Cập nhật payout = SUCCESS; Cập nhật số dư ví;
    :Ghi biên lai; Đưa vào lô đối soát kỳ sau;
    :Thông báo thành công;
  else (Thất bại)
    :Ghi lỗi & mã lỗi cổng; Cập nhật payout = FAILED;
    :Thông báo thất bại;
  endif
}

stop
@enduml
D3) Ví — Đóng băng / Giải băng (UC09)
plantuml
Sao chép mã
@startuml
start

partition "Admin" {
  :Chọn ví cần xử lý;
  if ("Đóng băng?") then (Có)
    :Nhập lý do & TTL;
  else (Giải băng)
    :Xác nhận hành động;
  endif
}

partition "Hệ thống" {
  if ("Đóng băng?") then (Có)
    :Đặt trạng thái ví = FROZEN;
  else (Giải băng)
    :Bỏ trạng thái FROZEN;
  endif
  :Thông báo chủ ví;
  :Ghi nhật ký audit;
}

stop
@enduml
E) Niêm yết & Giao dịch (UC10–UC12)
plantuml
Sao chép mã
@startuml
start

partition "Admin" {
  :Xem danh sách niêm yết bị gắn cờ;
  :Mở chi tiết niêm yết;
}

partition "Hệ thống" {
  :Hiển thị nội dung, lịch sử & bằng chứng;
}

partition "Admin" {
  if ("Có vi phạm?") then (Có)
    :Chọn Ẩn/Đóng băng niêm yết;
  else (Không)
    :Bỏ gắn cờ (false positive);
    stop
  endif
}

partition "Hệ thống" {
  :Cập nhật trạng thái (HIDDEN/FROZEN); Ghi audit;
  if ("Có đơn đã thanh toán?") then (Có)
    :Khởi động hoàn tiền/điều chỉnh đơn liên quan;
  else (Không)
    :Không có đơn cần xử lý;
  endif
  :Thông báo người bán;
}

stop
@enduml
F) Báo cáo & Cảnh báo (UC13–UC15)
plantuml
Sao chép mã
@startuml
start

partition "Admin" {
  :Chọn kỳ & chỉ số báo cáo;
}

partition "Hệ thống" {
  :Khởi chạy job tổng hợp (async); Theo dõi tiến độ;
  if ("Hoàn tất tổng hợp?") then (Xong)
    :Lưu kết quả vào DWH;
  else (Lỗi/Timeout)
    :Ghi log lỗi; Thông báo thất bại;
    stop
  endif
}

partition "Admin" {
  :Xem & lọc kết quả;
  :Chọn Export CSV/Excel;
}

partition "Hệ thống" {
  :Mask dữ liệu theo vai trò; Ký số tệp (nếu bật);
  :Tạo file tải xuống;
}

partition "Admin" {
  :Thiết lập/Điều chỉnh rule cảnh báo rủi ro (ngưỡng/tần suất/geo);
}

partition "Hệ thống" {
  :Lưu rule; Bật cảnh báo; Gửi alert khi trigger;
}

stop
@enduml