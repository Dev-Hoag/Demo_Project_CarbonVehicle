version: '3.8'

services:
  # ============================================
  # INFRASTRUCTURE SERVICES
  # ============================================
  
  # RabbitMQ Message Broker
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: ccm_rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"    # AMQP
      - "15672:15672"  # Management UI
    environment:
      - RABBITMQ_DEFAULT_USER=ccm_admin
      - RABBITMQ_DEFAULT_PASS=ccm_password_2024
      - RABBITMQ_DEFAULT_VHOST=ccm_vhost
    volumes:
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./rabbitmq/definitions.json:/etc/rabbitmq/definitions.json:ro
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - ccm_net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # API Gateway (Nginx)
  gateway:
    image: nginx:1.27-alpine
    container_name: api_gateway
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - ccm_net
    depends_on:
      - user-service
      - admin-service
      - payment-service
      - transaction-service
      - wallet-service
      - notification-service
      - trip-service
      - listing-service
      - credit-service

  # ============================================
  # NESTJS MICROSERVICES
  # ============================================

  # User Service
  user-service:
    build:
      context: ./User_Service
      dockerfile: Dockerfile
    container_name: user_service_app
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DB_HOST=user-mysql
      - DB_PORT=3306
      - DB_USERNAME=root
      - DB_PASSWORD=root
      - DB_NAME=user_service_db
      - JWT_SECRET=your_jwt_secret_key_here
      - JWT_EXPIRATION=1d
    depends_on:
      user-mysql:
        condition: service_healthy
    networks:
      - ccm_net
    volumes:
      - ./User_Service/uploads:/app/uploads

  user-mysql:
    image: mysql:8.0
    container_name: user_service_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: user_service_db
      TZ: Asia/Ho_Chi_Minh
    ports:
      - "3321:3306"
    volumes:
      - user_mysql_data:/var/lib/mysql
    networks:
      - ccm_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Admin Service
  admin-service:
    build:
      context: ./Admin_Service
      dockerfile: Dockerfile
    container_name: admin_service_app
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DB_HOST=admin-mysql
      - DB_PORT=3306
      - DB_USERNAME=root
      - DB_PASSWORD=root
      - DB_NAME=admin_service_db
      - JWT_SECRET=your_admin_jwt_secret
      - JWT_EXPIRATION=8h
    depends_on:
      admin-mysql:
        condition: service_healthy
    networks:
      - ccm_net

  admin-mysql:
    image: mysql:8.0
    container_name: admin_service_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: admin_service_db
      TZ: Asia/Ho_Chi_Minh
    ports:
      - "3322:3306"
    volumes:
      - admin_mysql_data:/var/lib/mysql
    networks:
      - ccm_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Payment Service
  payment-service:
    build:
      context: ./Payment_Service
      dockerfile: Dockerfile
    container_name: payment_service_app
    restart: unless-stopped
    ports:
      - "3007:3007"
    environment:
      - NODE_ENV=production
      - PORT=3007
      - DB_HOST=payment-mysql
      - DB_PORT=3306
      - DB_USERNAME=root
      - DB_PASSWORD=root
      - DB_NAME=payment_service_db
      - RABBITMQ_URL=amqp://ccm_admin:ccm_password_2024@ccm_rabbitmq:5672/ccm_vhost
      - VNPAY_TMN_CODE=your_vnpay_tmn_code
      - VNPAY_HASH_SECRET=your_vnpay_hash_secret
      - VNPAY_URL=https://sandbox.vnpayment.vn/paymentv2/vpcpay.html
      - VNPAY_RETURN_URL=http://localhost:5173/payment/return
    depends_on:
      payment-mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - ccm_net

  payment-mysql:
    image: mysql:8.0
    container_name: payment_service_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: payment_service_db
      TZ: Asia/Ho_Chi_Minh
    ports:
      - "3323:3306"
    volumes:
      - payment_mysql_data:/var/lib/mysql
    networks:
      - ccm_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Transaction Service
  transaction-service:
    build:
      context: ./Transaction_Service
      dockerfile: Dockerfile
    container_name: transaction_service_app
    restart: unless-stopped
    ports:
      - "3009:3009"
    environment:
      - NODE_ENV=production
      - PORT=3009
      - DB_HOST=transaction-mysql
      - DB_PORT=3306
      - DB_USERNAME=root
      - DB_PASSWORD=root
      - DB_NAME=transaction_service_db
    depends_on:
      transaction-mysql:
        condition: service_healthy
    networks:
      - ccm_net

  transaction-mysql:
    image: mysql:8.0
    container_name: transaction_service_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: transaction_service_db
      TZ: Asia/Ho_Chi_Minh
    ports:
      - "3324:3306"
    volumes:
      - transaction_mysql_data:/var/lib/mysql
    networks:
      - ccm_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Wallet Service
  wallet-service:
    build:
      context: ./Wallet_Service
      dockerfile: Dockerfile
    container_name: ccm_wallet_service
    restart: unless-stopped
    ports:
      - "3008:3008"
    environment:
      - NODE_ENV=production
      - PORT=3008
      - DB_HOST=wallet-mysql
      - DB_PORT=3306
      - DB_USERNAME=root
      - DB_PASSWORD=root
      - DB_NAME=wallet_service_db
      - RABBITMQ_URL=amqp://ccm_admin:ccm_password_2024@ccm_rabbitmq:5672/ccm_vhost
    depends_on:
      wallet-mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - ccm_net

  wallet-mysql:
    image: mysql:8.0
    container_name: ccm_wallet_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: wallet_service_db
      TZ: Asia/Ho_Chi_Minh
    ports:
      - "3325:3306"
    volumes:
      - wallet_mysql_data:/var/lib/mysql
    networks:
      - ccm_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Notification Service
  notification-service:
    build:
      context: ./Notification_Service
      dockerfile: Dockerfile
    container_name: notification_service_app
    restart: unless-stopped
    ports:
      - "3010:3010"
    environment:
      - NODE_ENV=production
      - PORT=3010
      - DB_HOST=notification-mysql
      - DB_PORT=3306
      - DB_USERNAME=root
      - DB_PASSWORD=root
      - DB_NAME=notification_service_db
      - RABBITMQ_URL=amqp://ccm_admin:ccm_password_2024@ccm_rabbitmq:5672/ccm_vhost
      - FIREBASE_PROJECT_ID=carbon-credit-marketplace
      - FIREBASE_SERVICE_ACCOUNT_PATH=/app/config/firebase-service-account.json
    depends_on:
      notification-mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - ccm_net
    volumes:
      - ./Notification_Service/config:/app/config

  notification-mysql:
    image: mysql:8.0
    container_name: notification_service_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: notification_service_db
      TZ: Asia/Ho_Chi_Minh
    ports:
      - "3320:3306"
    volumes:
      - notification_mysql_data:/var/lib/mysql
      - ./Notification_Service/notification_service_schema.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - ccm_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # SPRING BOOT MICROSERVICES (Java)
  # ============================================

  # Trip Service
  trip-service:
    build:
      context: ./trip-service
      dockerfile: Dockerfile
    container_name: evowner-trip-service
    restart: unless-stopped
    ports:
      - "8091:8091"
    environment:
      - SERVER_PORT=8091
      - SPRING_DATASOURCE_URL=jdbc:mysql://trip-mysql:3306/trip_service_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Ho_Chi_Minh
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=123456
      - RABBITMQ_HOST=ccm_rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=ccm_admin
      - RABBITMQ_PASSWORD=ccm_password_2024
      - RABBITMQ_VHOST=ccm_vhost
    depends_on:
      trip-mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - ccm_net

  trip-mysql:
    image: mysql:8.0.43
    container_name: mysql-trip-service
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: trip_service_db
      TZ: Asia/Ho_Chi_Minh
    ports:
      - "3319:3306"
    volumes:
      - trip_mysql_data:/var/lib/mysql
    networks:
      - ccm_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p123456"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Listing Service
  listing-service:
    build:
      context: ./listing-service
      dockerfile: Dockerfile
    container_name: evowner-listing-service
    restart: unless-stopped
    ports:
      - "8092:8092"
    environment:
      - SERVER_PORT=8092
      - SPRING_DATASOURCE_URL=jdbc:mysql://listing-mysql:3306/listing_service_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Ho_Chi_Minh
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=123456
      - SERVICES_TRIP_SERVICE_URL=http://trip-service:8091/api
      - SERVICES_CREDIT_SERVICE_URL=http://credit-service:8093/api
      - RABBITMQ_HOST=ccm_rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=ccm_admin
      - RABBITMQ_PASSWORD=ccm_password_2024
      - RABBITMQ_VHOST=ccm_vhost
    depends_on:
      listing-mysql:
        condition: service_healthy
      trip-service:
        condition: service_started
      credit-service:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    networks:
      - ccm_net

  listing-mysql:
    image: mysql:8.0.43
    container_name: mysql-listing-service
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: listing_service_db
      TZ: Asia/Ho_Chi_Minh
    ports:
      - "3317:3306"
    volumes:
      - listing_mysql_data:/var/lib/mysql
    networks:
      - ccm_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p123456"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Credit Service
  credit-service:
    build:
      context: ./credit-service
      dockerfile: Dockerfile
    container_name: evowner-credit-service
    restart: unless-stopped
    ports:
      - "8093:8093"
    environment:
      - SERVER_PORT=8093
      - SPRING_DATASOURCE_URL=jdbc:mysql://credit-mysql:3306/credit_service_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Ho_Chi_Minh
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=123456
      - RABBITMQ_HOST=ccm_rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=ccm_admin
      - RABBITMQ_PASSWORD=ccm_password_2024
      - RABBITMQ_VHOST=ccm_vhost
    depends_on:
      credit-mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - ccm_net

  credit-mysql:
    image: mysql:8.0.43
    container_name: mysql-credit-service
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: credit_service_db
      TZ: Asia/Ho_Chi_Minh
    ports:
      - "3318:3306"
    volumes:
      - credit_mysql_data:/var/lib/mysql
    networks:
      - ccm_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p123456"]
      interval: 10s
      timeout: 5s
      retries: 5

# ============================================
# VOLUMES
# ============================================
volumes:
  # RabbitMQ
  rabbitmq_data:
    name: ccm_rabbitmq_data
  
  # NestJS Services
  user_mysql_data:
    name: ccm_user_mysql_data
  admin_mysql_data:
    name: ccm_admin_mysql_data
  payment_mysql_data:
    name: ccm_payment_mysql_data
  transaction_mysql_data:
    name: ccm_transaction_mysql_data
  wallet_mysql_data:
    name: ccm_wallet_mysql_data
  notification_mysql_data:
    name: ccm_notification_mysql_data
  
  # Spring Boot Services
  trip_mysql_data:
    name: ccm_trip_mysql_data
  listing_mysql_data:
    name: ccm_listing_mysql_data
  credit_mysql_data:
    name: ccm_credit_mysql_data

# ============================================
# NETWORKS
# ============================================
networks:
  ccm_net:
    name: ccm_net
    driver: bridge
